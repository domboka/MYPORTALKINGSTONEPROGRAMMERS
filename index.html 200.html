<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Production Record System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      background: linear-gradient(135deg, #2c3e50, #3498db, #ecf0f1, #2ecc71);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: #333;
    }
    
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .container {
      position: relative;
      z-index: 10;
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 15px;
    }
    
    .login, .dashboard {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #bdc3c7;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      backdrop-filter: blur(8px);
    }
    
    h1, h2, h3, h4 {
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: 600;
    }
    
    h1 {
      text-align: center;
      font-size: 2.2rem;
      padding-bottom: 15px;
      border-bottom: 2px solid #3498db;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    input, select, textarea {
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #bdc3c7;
      margin: 8px 0 18px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
      background: rgba(236, 240, 241, 0.8);
      color: #2c3e50;
      transition: all 0.3s ease;
    }
    
    input::placeholder, textarea::placeholder {
      color: #7f8c8d;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
      background: rgba(236, 240, 241, 0.95);
    }
    
    textarea { 
      min-height: 120px; 
      resize: vertical;
    }
    
    button {
      padding: 14px 28px;
      cursor: pointer;
      background: linear-gradient(to right, #3498db, #2980b9);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      margin: 10px 6px;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      transition: all 0.3s ease;
      font-size: 1em;
      position: relative;
      overflow: hidden;
    }
    
    button:after {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }
    
    button:hover:after {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
      background: rgba(236, 240, 241, 0.8);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    th, td {
      border: 1px solid #bdc3c7;
      padding: 14px 16px;
      text-align: left;
    }
    
    th {
      background: #3498db;
      color: #fff;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: rgba(189, 195, 199, 0.2);
    }
    
    .hidden { display: none; }
    
    .project-bar {
      background: #ecf0f1;
      border-radius: 10px;
      margin-bottom: 20px;
      height: 30px;
      overflow: hidden;
      box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.1);
    }
    
    .project-progress {
      background: linear-gradient(to right, #3498db, #2ecc71);
      border-radius: 10px;
      height: 100%;
      transition: width 0.8s cubic-bezier(0.22, 0.61, 0.36, 1);
      box-shadow: 0 0 15px rgba(46, 204, 113, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .project-progress.completed {
      background: linear-gradient(to right, #2ecc71, #27ae60);
    }
    
    .progress-label { 
      margin: 15px 0 8px; 
      color: #2c3e50; 
      font-weight: 600; 
      font-size: 1.1em;
    }
    
    .admin-features {
      background: rgba(236, 240, 241, 0.9);
      padding: 20px;
      border-radius: 12px;
      margin: 25px 0;
      border: 1px solid #bdc3c7;
    }
    
    .admin-features h3, .admin-features h4 { 
      color: #2c3e50; 
      margin-top: 0;
    }
    
    .admin-features input, .admin-features button { 
      width: auto; 
      display: inline-block; 
      vertical-align: middle; 
      margin-right: 12px; 
      margin-bottom: 12px;
    }
    
    .admin-features hr { 
      border: none; 
      border-top: 1px solid #bdc3c7; 
      margin: 25px 0; 
    }
    
    .dashboard button.logout {
      background: linear-gradient(to right, #e74c3c, #c0392b);
      margin-top: 25px;
      margin-bottom: 10px;
    }
    
    .user-info {
      background: rgba(52, 152, 219, 0.8);
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      display: inline-block;
      font-weight: 500;
      border: 1px solid #2980b9;
      color: white;
    }
    
    .status-indicator {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #2ecc71;
      margin-right: 10px;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px rgba(46, 204, 113, 0.7);
    }
    
    @keyframes pulse {
      0% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0.7; transform: scale(1); }
    }
    
    .card {
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #bdc3c7;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }
    
    .project-card {
      background: rgba(236, 240, 241, 0.8);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid #3498db;
    }
    
    .project-card.completed {
      border-left: 4px solid #2ecc71;
      background: rgba(46, 204, 113, 0.15);
    }
    
    .project-card h4 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      margin-right: 10px;
    }
    
    .badge.pending {
      background: rgba(52, 152, 219, 0.3);
      color: #2980b9;
    }
    
    .badge.completed {
      background: rgba(46, 204, 113, 0.3);
      color: #27ae60;
    }
    
    .file-upload {
      position: relative;
      margin: 15px 0;
    }
    
    .file-upload input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-upload label {
      display: block;
      padding: 12px 20px;
      background: rgba(236, 240, 241, 0.8);
      border: 1px dashed #bdc3c7;
      border-radius: 8px;
      text-align: center;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .file-upload label:hover {
      background: rgba(236, 240, 241, 0.95);
      border-color: #3498db;
    }
    
    .file-list {
      margin: 15px 0;
      padding: 0;
      list-style: none;
    }
    
    .file-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(236, 240, 241, 0.8);
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .file-list li a {
      color: #2980b9;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .file-list li a:hover {
      text-decoration: underline;
    }
    
    .file-list li button {
      padding: 5px 10px;
      font-size: 0.9em;
      margin: 0;
    }
    
    .tab-container {
      margin: 25px 0;
    }
    
    .tabs {
      display: flex;
      border-bottom: 2px solid #bdc3c7;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 12px 25px;
      cursor: pointer;
      background: rgba(236, 240, 241, 0.8);
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .tab.active {
      background: #3498db;
      color: white;
      border-bottom: 3px solid #2980b9;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .project-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: rgba(236, 240, 241, 0.8);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      border-top: 4px solid #3498db;
    }
    
    .stat-card.completed {
      border-top: 4px solid #2ecc71;
    }
    
    .stat-card h3 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin: 10px 0;
    }
    
    .stat-card p {
      color: #7f8c8d;
    }
    
    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 30px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid #3498db;
      box-shadow: 0 0 30px rgba(52, 152, 219, 0.5);
    }
    
    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #2c3e50;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      background: rgba(46, 204, 113, 0.9);
      color: white;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(200%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* Dynamic background elements */
    .dynamic-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .bg-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
    }
    
    .bg-1 {
      width: 400px;
      height: 400px;
      background: #3498db;
      top: -100px;
      left: -100px;
      animation: float 15s infinite ease-in-out;
    }
    
    .bg-2 {
      width: 600px;
      height: 600px;
      background: #2ecc71;
      bottom: -200px;
      right: -200px;
      animation: float 20s infinite ease-in-out;
      animation-delay: 2s;
    }
    
    .bg-3 {
      width: 300px;
      height: 300px;
      background: #ecf0f1;
      top: 40%;
      left: 50%;
      animation: float 25s infinite ease-in-out;
      animation-delay: 5s;
    }
    
    .bg-4 {
      width: 500px;
      height: 500px;
      background: #2c3e50;
      bottom: 10%;
      left: 20%;
      animation: float 18s infinite ease-in-out;
      animation-delay: 7s;
    }
    
    @keyframes float {
      0% { transform: translate(0, 0); }
      25% { transform: translate(20px, 20px); }
      50% { transform: translate(0, 30px); }
      75% { transform: translate(-20px, 10px); }
      100% { transform: translate(0, 0); }
    }
    
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .login, .dashboard { padding: 20px; }
      button { width: 100%; margin: 10px 0; }
      .admin-features input, .admin-features button { width: 100%; margin: 8px 0; }
      .project-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="dynamic-bg">
    <div class="bg-element bg-1"></div>
    <div class="bg-element bg-2"></div>
    <div class="bg-element bg-3"></div>
    <div class="bg-element bg-4"></div>
  </div>
  
  <div id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modal-title">Project Details</h2>
      <div id="modal-content"></div>
    </div>
  </div>

  <div class="container">
    <div id="login" class="login">
      <h1>PRODUCTION RECORD SYSTEM</h1>
      <h2>Login to Dashboard</h2>
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <button onclick="login()">Login</button>
      <p id="login-error" style="color: #e74c3c; margin-top: 15px;"></p>
    </div>

    <div id="dashboard" class="dashboard hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
        <div>
          <h2>Production Stage Dashboard</h2>
          <div class="user-info">
            <span class="status-indicator"></span>
            <span id="welcome-user"></span>
            <span id="admin-label" style="color: #f1c40f; font-weight: 600;"></span>
          </div>
        </div>
        <div>
          <button onclick="logout()" class="logout">Logout</button>
        </div>
      </div>
      
      <div class="admin-features hidden" id="admin-features">
        <h3>Administration Panel</h3>
        
        <!-- Project Management Section -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <input type="text" id="new-project" placeholder="New Project Name" style="flex: 2;">
          <button onclick="addProject()">Add Project</button>
        </div>
        
        <!-- Project Deletion Section -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <select id="delete-project" style="flex: 2;">
            <option value="">Select Project to Delete</option>
          </select>
          <button onclick="deleteProject()">Delete Project</button>
        </div>
        
        <!-- Project Report Generation -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <select id="report-project" style="flex: 2;">
            <option value="">Select Project for Report</option>
          </select>
          <button onclick="generateProjectReport()">Generate Report</button>
        </div>
        
        <!-- User Management Section -->
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <input type="text" id="new-user" placeholder="New Username" style="flex: 1;">
          <input type="password" id="new-pass" placeholder="New Password" style="flex: 1;">
          <button onclick="addUser()">Add User</button>
        </div>
        
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <input type="text" id="remove-user" placeholder="Username to Remove" style="flex: 2;">
          <button onclick="removeUser()">Remove User</button>
        </div>
        
        <hr>
        
        <!-- Reporting Configuration -->
        <h4>Reporting Configuration</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <input type="email" id="new-email" placeholder="Add Reporting Email" style="flex: 2;">
          <button onclick="addEmail()">Add Email</button>
          <button onclick="showEmails()">Show Emails</button>
        </div>
        <div id="emails-container" class="hidden">
          <table>
            <thead>
              <tr><th>Email</th><th>Action</th></tr>
            </thead>
            <tbody id="emails-body"></tbody>
          </table>
        </div>
      </div>
      
      <div id="users-container" class="hidden">
        <h3>User Management</h3>
        <table id="users-table">
          <thead>
            <tr><th>Username</th><th>Password (hidden)</th><th>Action</th></tr>
          </thead>
          <tbody id="users-body"></tbody>
        </table>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <p>Total Projects</p>
          <h3 id="total-projects">0</h3>
        </div>
        <div class="stat-card">
          <p>Active Projects</p>
          <h3 id="pending-projects">0</h3>
        </div>
        <div class="stat-card completed">
          <p>Completed Projects</p>
          <h3 id="completed-projects">0</h3>
        </div>
      </div>
      
      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="active-projects">Active Projects</div>
          <div class="tab" data-tab="completed-projects">Completed Projects</div>
        </div>
        
        <div id="active-projects" class="tab-content active">
          <div class="card">
            <h3>Project Selection</h3>
            <p>Current Project: <strong id="project-name">None Selected</strong></p>
            <select id="project-select" onchange="selectProject()" style="margin-top: 15px;"></select>
          </div>
          
          <div class="card">
            <h3 id="stage-name">Stage 1: Planning</h3>
            <textarea id="stage-notes" placeholder="Enter stage notes, observations, or comments..."></textarea>
            
            <div class="file-upload">
              <input type="file" id="file-input" onchange="addFile()">
              <label for="file-input">+ Add Attachment</label>
            </div>
            
            <div class="file-list" id="file-list"></div>
            
            <button onclick="completeStage()">Mark Stage as Complete</button>
          </div>
          
          <div class="card">
            <h3>Project Progress</h3>
            <p>Current Stage: <strong id="stage-progress"></strong></p>
            <div class="progress-label">Overall Progress:</div>
            <div class="project-bar">
              <div class="project-progress" id="project-progress" style="width: 0%;"></div>
            </div>
          </div>
        </div>
        
        <div id="completed-projects" class="tab-content">
          <div class="project-grid" id="completed-projects-grid"></div>
        </div>
      </div>
      
      <div class="card">
        <h3>Audit Trail</h3>
        <table id="audit-table">
          <thead>
            <tr>
              <th>Project</th>
              <th>Stage</th>
              <th>Date</th>
              <th>Time</th>
              <th>Notes</th>
              <th>Attachments</th>
            </tr>
          </thead>
          <tbody id="audit-body"></tbody>
        </table>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button onclick="showEmailInterface()">Generate and Send Report</button>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">Action completed successfully!</div>

  <script>
    // Stages
    const stages = [
      "Stage 1: Planning",
      "Stage 2: Material Procurement",
      "Stage 3: Assembly",
      "Stage 4: Testing",
      "Stage 5: Quality Check",
      "Stage 6: Packaging",
      "Stage 7: Delivery",
      "Stage 8: Post-Delivery Review"
    ];

    // User credentials
    let users = {
      "admin": "password123",
      "MHAMHA J": "1235",
      "user2": "userpass2",
      "user3": "userpass3",
      "user4": "userpass4",
      "user5": "userpass5"
    };

    // Reset projects to zero as requested
    let projects = [];
    let projectData = {};
    let completedProjects = [];
    let completedProjectData = {};
    
    // Reporting emails
    let reportingEmails = ["dombokablessing1@gmail.com", "reports@company.com"];

    let currentProject = null;
    let currentUser = null;
    let currentReport = null;
    
    // Login function
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (users[username] === password) {
        currentUser = username;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('welcome-user').textContent = username;
        if (username === "admin") {
          document.getElementById('admin-label').textContent = "(Administrator)";
          document.getElementById('admin-features').classList.remove('hidden');
        } else {
          document.getElementById('admin-label').textContent = "";
          document.getElementById('admin-features').classList.add('hidden');
        }
        updateProjectSelect();
        updateDeleteProjectSelect();
        updateReportProjectSelect();
        updateStage();
        updateProgressBar();
        updateAuditTrail();
        updateProjectStats();
        renderCompletedProjects();
        showNotification("Login successful!");
      } else {
        document.getElementById('login-error').textContent = 'Invalid username or password';
      }
    }

    // Logout
    function logout() {
      currentUser = null;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('login').classList.remove('hidden');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('login-error').textContent = '';
    }

    // Add user (admin only)
    function addUser() {
      if (currentUser !== "admin") return;
      const username = document.getElementById('new-user').value.trim();
      const password = document.getElementById('new-pass').value;
      if (username && password) {
        if(users[username]) {
          showNotification("User already exists!");
          return;
        }
        users[username] = password;
        document.getElementById('new-user').value = '';
        document.getElementById('new-pass').value = '';
        showUsers();
        showNotification(`User ${username} added!`);
      } else {
        showNotification('Please enter both username and password');
      }
    }

    // Remove user (admin only)
    function removeUser() {
      if (currentUser !== "admin") return;
      const username = document.getElementById('remove-user').value.trim();
      if (username === "admin") {
        showNotification("Cannot remove admin user!");
        return;
      }
      if (users[username]) {
        delete users[username];
        document.getElementById('remove-user').value = '';
        showUsers();
        showNotification(`User ${username} removed!`);
      } else {
        showNotification('User not found');
      }
    }

    // Add project (admin only)
    function addProject() {
      if (currentUser !== "admin") return;
      const projectName = document.getElementById('new-project').value.trim();
      if (projectName) {
        if (projects.includes(projectName) || completedProjects.includes(projectName)) {
          showNotification("Project already exists!");
          return;
        }
        projects.push(projectName);
        projectData[projectName] = { 
          currentStage: 0, 
          completed: false,
          files: [],
          auditTrail: [] 
        };
        updateProjectSelect();
        updateDeleteProjectSelect();
        updateReportProjectSelect();
        document.getElementById('new-project').value = '';
        updateProjectStats();
        showNotification(`Project ${projectName} added!`);
      }
    }

    // Delete project (admin only)
    function deleteProject() {
      if (currentUser !== "admin") return;
      
      const projectName = document.getElementById('delete-project').value;
      if (!projectName) {
        showNotification("Please select a project to delete");
        return;
      }

      // Delete from active projects
      if (projects.includes(projectName)) {
        const index = projects.indexOf(projectName);
        projects.splice(index, 1);
        delete projectData[projectName];
      }
      
      // Delete from completed projects
      if (completedProjects.includes(projectName)) {
        const index = completedProjects.indexOf(projectName);
        completedProjects.splice(index, 1);
        delete completedProjectData[projectName];
      }
      
      // Reset UI if current project was deleted
      if (currentProject === projectName) {
        currentProject = null;
        document.getElementById('project-name').textContent = "None Selected";
        document.getElementById('stage-notes').value = '';
        document.getElementById('file-list').innerHTML = '';
      }
      
      updateProjectSelect();
      updateDeleteProjectSelect();
      updateReportProjectSelect();
      updateProjectStats();
      renderCompletedProjects();
      showNotification(`Project "${projectName}" deleted successfully!`);
    }

    // Generate specific project report (admin only)
    function generateProjectReport() {
      if (currentUser !== "admin") return;
      
      const projectName = document.getElementById('report-project').value;
      if (!projectName) {
        showNotification("Please select a project for reporting");
        return;
      }

      let report = `PRODUCTION REPORT: ${projectName}\n\n`;
      
      // Check if project is active
      if (projectData[projectName]) {
        report += "STATUS: Active\n";
        report += `CURRENT STAGE: ${stages[projectData[projectName].currentStage]}\n\n`;
        report += "AUDIT TRAIL:\n";
        projectData[projectName].auditTrail.forEach(record => {
          report += `[${record.date} ${record.time}] ${record.stage}\nNotes: ${record.notes}\n\n`;
        });
      }
      // Check if project is completed
      else if (completedProjectData[projectName]) {
        report += `STATUS: Completed (${completedProjectData[projectName].completionDate})\n`;
        report += "AUDIT TRAIL:\n";
        completedProjectData[projectName].auditTrail.forEach(record => {
          report += `[${record.date} ${record.time || ''}] ${record.stage}\nNotes: ${record.notes}\n\n`;
        });
      } else {
        showNotification("Project data not found");
        return;
      }
      
      currentReport = report;
      showReportModal(`Production Report: ${projectName}`, report);
    }
    
    // Show report in modal
    function showReportModal(title, report) {
      document.getElementById('modal-title').textContent = title;
      
      const content = `
        <div style="padding: 20px; background: rgba(236, 240, 241, 0.5); border-radius: 10px; margin: 15px 0;">
          <div style="border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; text-align: center;">
            <h3>${title}</h3>
          </div>
          
          <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 8px; margin-top: 20px; max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;">
            ${report}
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <button class="btn" onclick="copyReportToClipboard()">Copy Report</button>
            <button class="btn green" onclick="sendReportViaEmail('${title}')">Send via Email</button>
          </div>
        </div>
      `;
      
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal').style.display = 'flex';
    }
    
    // Copy report to clipboard
    function copyReportToClipboard() {
      if (!currentReport) return;
      
      const textarea = document.createElement('textarea');
      textarea.value = currentReport;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      showNotification('Report copied to clipboard!');
    }
    
    // Send report via email
    function sendReportViaEmail(title) {
      if (!currentReport) return;
      
      const subject = encodeURIComponent(title);
      const body = encodeURIComponent(currentReport);
      const mailto = `mailto:${reportingEmails.join(',')}?subject=${subject}&body=${body}`;
      
      window.location.href = mailto;
    }
    
    // Show email interface for current project
    function showEmailInterface() {
      if (!currentProject || !projectData[currentProject]) {
        showNotification("Select a project first!");
        return;
      }
      
      let report = `Production Stage Completion Report for Project: ${currentProject}\n\n`;
      projectData[currentProject].auditTrail.forEach(record => {
        report += `Stage: ${record.stage}\nDate: ${record.date}\nTime: ${record.time}\nNotes: ${record.notes}\n\n`;
      });
      
      currentReport = report;
      showReportModal(`Production Report: ${currentProject}`, report);
    }

    // Update project select dropdown
    function updateProjectSelect() {
      const select = document.getElementById('project-select');
      select.innerHTML = '<option value="">Select Project</option>';
      projects.forEach(project => {
        if (!projectData[project].completed) {
          select.innerHTML += `<option value="${project}" ${currentProject === project ? 'selected' : ''}>${project}</option>`;
        }
      });
    }
    
    // Update delete project dropdown
    function updateDeleteProjectSelect() {
      const select = document.getElementById('delete-project');
      select.innerHTML = '<option value="">Select Project to Delete</option>';
      
      // Add active projects
      projects.forEach(project => {
        select.innerHTML += `<option value="${project}">${project} (Active)</option>`;
      });
      
      // Add completed projects
      completedProjects.forEach(project => {
        select.innerHTML += `<option value="${project}">${project} (Completed)</option>`;
      });
    }
    
    // Update report project dropdown
    function updateReportProjectSelect() {
      const select = document.getElementById('report-project');
      select.innerHTML = '<option value="">Select Project for Report</option>';
      
      // Add active projects
      projects.forEach(project => {
        select.innerHTML += `<option value="${project}">${project} (Active)</option>`;
      });
      
      // Add completed projects
      completedProjects.forEach(project => {
        select.innerHTML += `<option value="${project}">${project} (Completed)</option>`;
      });
    }

    // Select project
    function selectProject() {
      currentProject = document.getElementById('project-select').value;
      document.getElementById('project-name').textContent = currentProject || "None Selected";
      updateStage();
      updateProgressBar();
      updateAuditTrail();
      updateFileList();
    }

    // Show users (admin only)
    function showUsers() {
      if (currentUser !== "admin") return;
      const container = document.getElementById('users-container');
      const tbody = document.getElementById('users-body');
      tbody.innerHTML = '';
      for (const [username, password] of Object.entries(users)) {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = username;
        row.insertCell(1).textContent = "â€¢â€¢â€¢â€¢â€¢â€¢â€¢";
        if (username !== "admin") {
          const cell = row.insertCell(2);
          const btn = document.createElement('button');
          btn.textContent = 'Delete';
          btn.onclick = () => deleteUser(username);
          cell.appendChild(btn);
        } else {
          row.insertCell(2).textContent = "-";
        }
      }
      container.classList.toggle('hidden');
    }

    // Delete user (admin only)
    function deleteUser(username) {
      if (currentUser !== "admin" || username === "admin") return;
      delete users[username];
      showUsers();
      showNotification(`User ${username} deleted!`);
    }

    // Show projects
    function showProjects() {
      showNotification("Active Projects:\n" + projects.join("\n"));
    }

    // Show reporting emails (admin only)
    function showEmails() {
      if (currentUser !== "admin") return;
      const container = document.getElementById('emails-container');
      const tbody = document.getElementById('emails-body');
      tbody.innerHTML = '';
      reportingEmails.forEach((email, idx) => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = email;
        const cell = row.insertCell(1);
        const btn = document.createElement('button');
        btn.textContent = 'Remove';
        btn.onclick = () => deleteEmail(idx);
        cell.appendChild(btn);
      });
      container.classList.toggle('hidden');
    }

    // Add reporting email (admin only)
    function addEmail() {
      if (currentUser !== "admin") return;
      const email = document.getElementById('new-email').value.trim();
      if (email && validateEmail(email)) {
        if (reportingEmails.includes(email)) {
          showNotification("Email already exists!");
          return;
        }
        reportingEmails.push(email);
        document.getElementById('new-email').value = '';
        showEmails();
        showNotification(`Reporting email ${email} added!`);
      } else {
        showNotification("Enter a valid email address.");
      }
    }

    // Remove reporting email (admin only)
    function deleteEmail(idx) {
      if (currentUser !== "admin") return;
      const email = reportingEmails.splice(idx, 1)[0];
      showEmails();
      showNotification(`Email ${email} removed!`);
    }

    // Email validation
    function validateEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    // Update stage display
    function updateStage() {
      if (!currentProject || !projectData[currentProject]) {
        document.getElementById('stage-name').textContent = "Stage 1: Planning";
        document.getElementById('stage-progress').textContent = "";
        return;
      }
      let stageIdx = projectData[currentProject].currentStage;
      document.getElementById('stage-name').textContent = stages[stageIdx];
      document.getElementById('stage-progress').textContent = stages[stageIdx];
    }

    // Add file attachment
    function addFile() {
      const fileInput = document.getElementById('file-input');
      if (!fileInput.files.length) return;
      
      const file = fileInput.files[0];
      const fileName = file.name;
      const fileSize = (file.size / 1024).toFixed(2) + " KB";
      
      // Store file info
      projectData[currentProject].files.push({
        name: fileName,
        size: fileSize,
        type: file.type
      });
      
      updateFileList();
      fileInput.value = '';
      showNotification(`File "${fileName}" added to project!`);
    }
    
    // Update file list display
    function updateFileList() {
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      
      if (!currentProject || !projectData[currentProject] || !projectData[currentProject].files.length) {
        return;
      }
      
      projectData[currentProject].files.forEach((file, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <a href="#" onclick="downloadFile('${file.name}')">
            ðŸ“„ ${file.name} (${file.size})
          </a>
          <button onclick="removeFile(${index})">Remove</button>
        `;
        fileList.appendChild(li);
      });
    }
    
    // Simulate file download
    function downloadFile(fileName) {
      showNotification(`Downloading "${fileName}"`);
      // This would be replaced with actual file download logic
    }
    
    // Remove file
    function removeFile(index) {
      projectData[currentProject].files.splice(index, 1);
      updateFileList();
      showNotification("File removed!");
    }

    // Complete stage (automatic report)
    function completeStage() {
      if (!currentProject || !projectData[currentProject]) {
        showNotification('Please select a project first!');
        return;
      }
      
      if (projectData[currentProject].completed) {
        showNotification('This project is already completed!');
        return;
      }
      
      const notes = document.getElementById('stage-notes').value;
      const now = new Date();
      let stageIdx = projectData[currentProject].currentStage;
      
      // Create record
      const record = {
        project: currentProject,
        stage: stages[stageIdx],
        date: now.toLocaleDateString(),
        time: now.toLocaleTimeString(),
        notes: notes,
        files: [...projectData[currentProject].files]
      };
      
      // Add to audit trail
      projectData[currentProject].auditTrail.push(record);
      
      // Check if this is the last stage
      if (stageIdx === stages.length - 1) {
        // Complete the project
        projectData[currentProject].completed = true;
        completedProjects.push(currentProject);
        completedProjectData[currentProject] = {
          completionDate: now.toLocaleDateString(),
          stages: stages.length,
          auditTrail: [...projectData[currentProject].auditTrail]
        };
        
        // Remove from active projects
        const index = projects.indexOf(currentProject);
        if (index > -1) {
          projects.splice(index, 1);
        }
        
        // Reset UI
        currentProject = null;
        document.getElementById('project-name').textContent = "None Selected";
        document.getElementById('stage-notes').value = '';
        document.getElementById('file-list').innerHTML = '';
        
        showNotification(`Project completed successfully!`);
      } else {
        // Move to next stage
        projectData[currentProject].currentStage = stageIdx + 1;
        projectData[currentProject].files = [];
        document.getElementById('stage-notes').value = '';
        document.getElementById('file-list').innerHTML = '';
      }
      
      updateStage();
      updateProgressBar();
      updateAuditTrail();
      updateProjectSelect();
      updateDeleteProjectSelect();
      updateReportProjectSelect();
      updateProjectStats();
      renderCompletedProjects();
      autoSendReport(record);
    }

    // Update progress bar
    function updateProgressBar() {
      if (!currentProject || !projectData[currentProject]) {
        document.getElementById('project-progress').style.width = '0%';
        return;
      }
      let stageIdx = projectData[currentProject].currentStage;
      const progress = Math.round((stageIdx / stages.length) * 100);
      document.getElementById('project-progress').style.width = progress + '%';
      
      // Update progress bar style if completed
      if (projectData[currentProject].completed) {
        document.getElementById('project-progress').classList.add('completed');
      } else {
        document.getElementById('project-progress').classList.remove('completed');
      }
    }

    // Update audit trail table
    function updateAuditTrail() {
      const tbody = document.getElementById('audit-body');
      tbody.innerHTML = '';
      
      if (!currentProject || !projectData[currentProject]) return;
      
      projectData[currentProject].auditTrail.forEach(record => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = record.project;
        row.insertCell(1).textContent = record.stage;
        row.insertCell(2).textContent = record.date;
        row.insertCell(3).textContent = record.time;
        row.insertCell(4).textContent = record.notes;
        
        // Add attachments column
        const attachmentsCell = row.insertCell(5);
        if (record.files && record.files.length > 0) {
          record.files.forEach(file => {
            const link = document.createElement('a');
            link.href = "#";
            link.textContent = file.name;
            link.onclick = () => downloadFile(file.name);
            link.style.marginRight = "8px";
            attachmentsCell.appendChild(link);
          });
        } else {
          attachmentsCell.textContent = "None";
        }
      });
    }
    
    // Update project statistics
    function updateProjectStats() {
      document.getElementById('total-projects').textContent = projects.length + completedProjects.length;
      document.getElementById('pending-projects').textContent = projects.length;
      document.getElementById('completed-projects').textContent = completedProjects.length;
    }
    
    // Render completed projects
    function renderCompletedProjects() {
      const container = document.getElementById('completed-projects-grid');
      container.innerHTML = '';
      
      completedProjects.forEach(project => {
        const projectInfo = completedProjectData[project];
        if (!projectInfo) return;
        
        const card = document.createElement('div');
        card.className = 'project-card completed';
        card.innerHTML = `
          <h4>${project}</h4>
          <p><span class="badge completed">Completed</span> ${projectInfo.completionDate}</p>
          <p>${projectInfo.stages} Stages Completed</p>
          <button style="margin-top: 10px;" onclick="viewProjectDetails('${project}')">View Details</button>
        `;
        container.appendChild(card);
      });
    }
    
    // View project details
    function viewProjectDetails(project) {
      const projectInfo = completedProjectData[project];
      if (!projectInfo) return;
      
      document.getElementById('modal-title').textContent = project;
      
      let content = `
        <p><strong>Completion Date:</strong> ${projectInfo.completionDate}</p>
        <p><strong>Total Stages:</strong> ${projectInfo.stages}</p>
        <h3 style="margin-top:20px;margin-bottom:10px;">Audit Trail</h3>
        <table style="width:100%;">
          <thead>
            <tr>
              <th>Stage</th>
              <th>Date</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      projectInfo.auditTrail.forEach(record => {
        content += `
          <tr>
            <td>${record.stage}</td>
            <td>${record.date}</td>
            <td>${record.notes}</td>
          </tr>
        `;
      });
      
      content += `
          </tbody>
        </table>
      `;
      
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal').style.display = 'flex';
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    // Automatic report sending on stage completion
    function autoSendReport(record) {
      let report = `Automatic Stage Completion Notification\n\nProject: ${record.project}\nStage: ${record.stage}\nDate: ${record.date}\nTime: ${record.time}\nNotes: ${record.notes}\n`;
      
      // Open email client with pre-filled data
      const subject = encodeURIComponent(`Stage Completion: ${record.project} - ${record.stage}`);
      const body = encodeURIComponent(report);
      const mailto = `mailto:${reportingEmails.join(',')}?subject=${subject}&body=${body}`;
      
      window.location.href = mailto;
    }
    
    // Switch tabs
    function switchTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Deactivate all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Activate selected tab
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
    }
    
    // Show notification
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Initialize
    window.onload = function() {
      updateProjectSelect();
      updateDeleteProjectSelect();
      updateReportProjectSelect();
      updateProjectStats();
      renderCompletedProjects();
      
      // Setup tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          switchTab(tab.dataset.tab);
        });
      });
    };
  </script>
</body>
</html>